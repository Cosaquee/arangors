language: rust
rust:
  - stable
  - beta
  - nightly
matrix:
  allow_failures:
    - rust: stable
    - rust: beta
  fast_finish: true
  include:
    - name: cargo doc
      rust: nightly
      script:
        - RUSTDOCFLAGS=-Dwarnings cargo doc --all
cache:
  cargo: true
  # directories:
  #   - /var/lib/docker

sudo: required

services:
  - docker

env:
  - DOCKER_COMPOSE_VERSION=1.22.0
  - secure: JM/YsyVdzZ3g8OXLBHp5gnPOTPwZebZmeoFypydLQ3ttN6EldRW7r7y4hRgrU00cjj7gNXTzU0Rud1BR8NzZmnrqdWN6WUYYhIq2bBYP9uVdPpXOS6FB2+g/3HQcfSbxsaCOwxhE5bmocIYpLOhGqeUf1YHrEeE+Wq79BFopHLSs1RF/eDIjXkLnBkIjij0LGIrhR8dJg/CWw6qAU9oymucgWDjzXviVl5MCmQSiOG6RxXYC6D+K4wmMoure+R1HGgxUzZ+qlVVxaZ2/qMKt9XlKdxa0cGGwprjnVDp7geafSd+JuxoJz7qor2jJL7BSDcgUuEQnOCbxJvZey67hVSmg/6tk91rmFN32NSSJW2cmSOLTntvfstiRGg2JMT3CidxStvF8KrePPDtYMdIGZyPUfmgS35ce0dq7l5ZwWs+eHHjCdlIXXmbBlJfVfDlylnJuP6ZDJqUgZzoMIngJ66GQmsdQKZy3XczkC2diTGKWddNxyqVaRUbr7yCdCIq0QbSL35hIips4r1Uw0quOBTC3SgQSZMUmc3GpIISNXAYmeAYv34drsgqSMxq+5Ts3nDR5nJW/sW5RMDz0c6UpSGi999ApQuBEGKmnT9RGQ/Zzxli/JNYz8ijRbu2HBgRB34bHZKsPjzI4vFoeJBlEAf49UbOO8bNGmgU9edBueZE=

addons:
  apt:
    packages:
      - binutils-dev
      - cmake
      - docker-ce
      - gcc
      - libcurl4-openssl-dev
      - libdw-dev
      - libelf-dev
      - libiberty-dev

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker --version
  - docker-compose --version
  - docker-compose up -d
  - sleep 30
  - docker container ls
  - docker-compose logs

before_script:
  - sh tests/init_db.sh
  - rustup component add rustfmt-preview

script:
  - cargo fmt --all -- --check
  - cargo build --verbose --all
  - RUST_LOG=arangors=trace cargo test --verbose --all

notifications:
  email:
    on_success: never

deploy:
  provider: script
  script: cargo publish --token $CARGO_TOKEN
  on:
    tags: true
    branch: master
    condition: "$TRAVIS_RUST_VERSION = nightly"
